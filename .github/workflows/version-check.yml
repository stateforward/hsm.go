name: Version Check

on:
  push:
    branches-ignore: [main, master]
  pull_request:
    branches: [main, master]
    types: [opened, ready_for_review]

jobs:
  check-version:
    name: Check Module Versions
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
          else
            BASE_SHA=$(git rev-parse HEAD^)
            HEAD_SHA=$(git rev-parse HEAD)
          fi

          CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Determine which modules have changes (excluding version.go files)
          ROOT_CHANGED="false"
          KIND_CHANGED="false"
          MUID_CHANGED="false"

          # Check for root module changes (files not in kind/ or muid/)
          if echo "$CHANGED_FILES" | grep -v "^kind/" | grep -v "^muid/" | grep -v "^\.github/" | grep -q "\.go$"; then
            ROOT_CHANGED="true"
          fi

          # Check for kind module changes
          if echo "$CHANGED_FILES" | grep -q "^kind/.*\.go$"; then
            KIND_CHANGED="true"
          fi

          # Check for muid module changes
          if echo "$CHANGED_FILES" | grep -q "^muid/.*\.go$"; then
            MUID_CHANGED="true"
          fi

          echo "root_changed=$ROOT_CHANGED" >> $GITHUB_OUTPUT
          echo "kind_changed=$KIND_CHANGED" >> $GITHUB_OUTPUT
          echo "muid_changed=$MUID_CHANGED" >> $GITHUB_OUTPUT

      - name: Fetch base branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            TARGET_REF="${{ github.base_ref }}"
          else
            TARGET_REF="main"
          fi
          git fetch origin $TARGET_REF --depth=1

      - name: Check root module version
        if: steps.changed.outputs.root_changed == 'true'
        run: |
          TARGET_REF="origin/${{ github.event_name == 'pull_request' && github.base_ref || 'main' }}"

          # Get base version
          BASE_VERSION="v0.0.0"
          if git cat-file -e $TARGET_REF:version.go 2>/dev/null; then
            BASE_VERSION=$(git show $TARGET_REF:version.go | grep 'const Version = ' | cut -d'"' -f2 || echo "v0.0.0")
          fi

          # Get PR version
          if [ ! -f version.go ]; then
            echo "‚ùå version.go not found"
            exit 1
          fi
          PR_VERSION=$(grep 'const Version = ' version.go | cut -d'"' -f2)

          echo "Root module: Base=$BASE_VERSION, PR=$PR_VERSION"

          # Compare versions
          source .github/scripts/version-compare.sh 2>/dev/null || {
            # Inline version comparison if script doesn't exist
            compare_versions() {
              local a=${1#v}
              local b=${2#v}
              IFS='.' read -r a1 a2 a3 <<< "$a"
              IFS='.' read -r b1 b2 b3 <<< "$b"
              if [ "$a1" -gt "$b1" ]; then return 0; fi
              if [ "$a1" -lt "$b1" ]; then return 1; fi
              if [ "$a2" -gt "$b2" ]; then return 0; fi
              if [ "$a2" -lt "$b2" ]; then return 1; fi
              if [ "$a3" -gt "$b3" ]; then return 0; fi
              return 1
            }
          }

          if [ "$BASE_VERSION" = "$PR_VERSION" ]; then
            echo "‚ùå Root module version must be updated in version.go"
            echo "   Current: $BASE_VERSION"
            exit 1
          fi

          compare_versions "$PR_VERSION" "$BASE_VERSION" || {
            echo "‚ùå Root module version must be incremented"
            echo "   Base: $BASE_VERSION -> PR: $PR_VERSION"
            exit 1
          }

          echo "‚úÖ Root module version check passed: $BASE_VERSION -> $PR_VERSION"

      - name: Check kind module version
        if: steps.changed.outputs.kind_changed == 'true'
        run: |
          TARGET_REF="origin/${{ github.event_name == 'pull_request' && github.base_ref || 'main' }}"

          BASE_VERSION="v0.0.0"
          if git cat-file -e $TARGET_REF:kind/version.go 2>/dev/null; then
            BASE_VERSION=$(git show $TARGET_REF:kind/version.go | grep 'const Version = ' | cut -d'"' -f2 || echo "v0.0.0")
          fi

          if [ ! -f kind/version.go ]; then
            echo "‚ùå kind/version.go not found"
            exit 1
          fi
          PR_VERSION=$(grep 'const Version = ' kind/version.go | cut -d'"' -f2)

          echo "Kind module: Base=$BASE_VERSION, PR=$PR_VERSION"

          compare_versions() {
            local a=${1#v}
            local b=${2#v}
            IFS='.' read -r a1 a2 a3 <<< "$a"
            IFS='.' read -r b1 b2 b3 <<< "$b"
            if [ "$a1" -gt "$b1" ]; then return 0; fi
            if [ "$a1" -lt "$b1" ]; then return 1; fi
            if [ "$a2" -gt "$b2" ]; then return 0; fi
            if [ "$a2" -lt "$b2" ]; then return 1; fi
            if [ "$a3" -gt "$b3" ]; then return 0; fi
            return 1
          }

          if [ "$BASE_VERSION" = "$PR_VERSION" ]; then
            echo "‚ùå Kind module version must be updated in kind/version.go"
            exit 1
          fi

          compare_versions "$PR_VERSION" "$BASE_VERSION" || {
            echo "‚ùå Kind module version must be incremented"
            exit 1
          }

          echo "‚úÖ Kind module version check passed: $BASE_VERSION -> $PR_VERSION"

      - name: Check muid module version
        if: steps.changed.outputs.muid_changed == 'true'
        run: |
          TARGET_REF="origin/${{ github.event_name == 'pull_request' && github.base_ref || 'main' }}"

          BASE_VERSION="v0.0.0"
          if git cat-file -e $TARGET_REF:muid/version.go 2>/dev/null; then
            BASE_VERSION=$(git show $TARGET_REF:muid/version.go | grep 'const Version = ' | cut -d'"' -f2 || echo "v0.0.0")
          fi

          if [ ! -f muid/version.go ]; then
            echo "‚ùå muid/version.go not found"
            exit 1
          fi
          PR_VERSION=$(grep 'const Version = ' muid/version.go | cut -d'"' -f2)

          echo "MUID module: Base=$BASE_VERSION, PR=$PR_VERSION"

          compare_versions() {
            local a=${1#v}
            local b=${2#v}
            IFS='.' read -r a1 a2 a3 <<< "$a"
            IFS='.' read -r b1 b2 b3 <<< "$b"
            if [ "$a1" -gt "$b1" ]; then return 0; fi
            if [ "$a1" -lt "$b1" ]; then return 1; fi
            if [ "$a2" -gt "$b2" ]; then return 0; fi
            if [ "$a2" -lt "$b2" ]; then return 1; fi
            if [ "$a3" -gt "$b3" ]; then return 0; fi
            return 1
          }

          if [ "$BASE_VERSION" = "$PR_VERSION" ]; then
            echo "‚ùå MUID module version must be updated in muid/version.go"
            exit 1
          fi

          compare_versions "$PR_VERSION" "$BASE_VERSION" || {
            echo "‚ùå MUID module version must be incremented"
            exit 1
          }

          echo "‚úÖ MUID module version check passed: $BASE_VERSION -> $PR_VERSION"

      - name: Summary
        run: |
          echo "## Version Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.changed.outputs.root_changed }}" = "true" ]; then
            echo "- üì¶ Root module (hsm.go) - checked" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed.outputs.kind_changed }}" = "true" ]; then
            echo "- üì¶ Kind module - checked" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed.outputs.muid_changed }}" = "true" ]; then
            echo "- üì¶ MUID module - checked" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ steps.changed.outputs.root_changed }}" = "false" ] && \
             [ "${{ steps.changed.outputs.kind_changed }}" = "false" ] && \
             [ "${{ steps.changed.outputs.muid_changed }}" = "false" ]; then
            echo "- ‚ÑπÔ∏è No Go files changed in any module" >> $GITHUB_STEP_SUMMARY
          fi
